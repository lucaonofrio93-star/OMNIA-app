<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNIA - Accademia</title>
    <style>
        :root {
            --primary: #00ff88;
            --bg: #0a0a0a;
            --card-bg: #151515;
            --text: #eeeeee;
        }
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container { max-width: 1100px; width: 100%; text-align: center; }
        h1 { color: var(--primary); font-size: 2.5rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 3px; }
        p.subtitle { color: #888; margin-bottom: 30px; }
        
        .setup-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #333;
            margin-bottom: 30px;
            display: inline-block;
        }
        input {
            padding: 12px 15px;
            width: 300px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #000;
            color: white;
            outline: none;
        }
        input:focus { border-color: var(--primary); }
        
        button {
            cursor: pointer;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            transition: all 0.2s;
            margin: 5px;
        }
        .btn-save { background: #4a90e2; color: white; }
        .btn-main { 
            background: var(--primary); 
            color: black; 
            font-size: 1.2rem; 
            padding: 15px 40px; 
            border-radius: 50px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
        }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        button:disabled { background: #444 !important; color: #888; cursor: not-allowed; transform: none; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #333;
            text-align: left;
            border-top: 4px solid var(--primary);
            transition: border-color 0.3s;
        }
        .card:hover { border-color: var(--primary); }
        .card h3 { 
            margin: 0 0 15px 0; 
            color: var(--primary); 
            font-size: 1.1rem; 
            display: flex;
            align-items: center;
        }
        .card p { 
            margin: 0; 
            line-height: 1.6; 
            color: #ccc; 
            font-size: 1rem;
        }
        
        #status-msg { margin-top: 10px; font-size: 0.9rem; min-height: 1.2em; }
        .error { color: #ff4444; }
        .success { color: var(--primary); }
        
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>OMNIA Accademia</h1>
        <p class="subtitle">Il tuo hub di conoscenza generato dall'Intelligenza Artificiale</p>
        
        <div class="setup-section">
            <input type="password" id="apiKey" placeholder="Incolla qui la tua API Key Gemini">
            <button class="btn-save" onclick="salvaChiave()">Salva</button>
            <div id="status-msg"></div>
        </div>

        <br>
        <button id="mainBtn" class="btn-main" onclick="generaContenuti()">ðŸ”„ AGGIORNA CONOSCENZA</button>
        <div id="loader" class="loading-spinner"></div>

        <div id="grid" class="grid">
            <!-- Le card verranno inserite qui -->
        </div>
    </div>

    <script>
        const categories = ['Storia IT', 'Geopolitica', 'AttualitÃ ', 'Letteratura', 'Arte', 'Musica'];
        let apiKey = localStorage.getItem('omnia_key') || '';

        // Inizializzazione pagina
        window.onload = () => {
            if (apiKey) document.getElementById('apiKey').value = apiKey;
            renderPlaceholder();
        };

        function salvaChiave() {
            const val = document.getElementById('apiKey').value.trim();
            if (val) {
                apiKey = val;
                localStorage.setItem('omnia_key', apiKey);
                mostraMessaggio("Chiave salvata correttamente!", "success");
            } else {
                mostraMessaggio("Inserisci una chiave valida.", "error");
            }
        }

        function mostraMessaggio(msg, type) {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            el.className = type;
            setTimeout(() => { el.innerText = ""; }, 4000);
        }

        function renderPlaceholder() {
            const grid = document.getElementById('grid');
            grid.innerHTML = categories.map(cat => `
                <div class="card" id="card-${cat.replace(/\s+/g, '')}">
                    <h3>${cat}</h3>
                    <p>In attesa di dati... Clicca sul tasto sopra per generare.</p>
                </div>
            `).join('');
        }

        async function generaContenuti() {
            if (!apiKey) {
                alert("Per favore, inserisci e salva la tua API Key prima di iniziare.");
                return;
            }

            const btn = document.getElementById('mainBtn');
            const loader = document.getElementById('loader');
            
            btn.disabled = true;
            loader.style.display = 'block';

            try {
                // Prompt ottimizzato per ricevere una risposta strutturata facile da leggere
                const prompt = `Genera 6 pillole di cultura generale (una per categoria). 
                Categorie: ${categories.join(', ')}.
                Sii conciso (max 25 parole per pillola).
                Formatta la risposta ESATTAMENTE cosÃ¬, una riga per categoria:
                Storia IT: [testo]
                Geopolitica: [testo]
                AttualitÃ : [testo]
                Letteratura: [testo]
                Arte: [testo]
                Musica: [testo]`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);
                
                const textResponse = data.candidates[0].content.parts[0].text;
                aggiornaInterfaccia(textResponse);
                mostraMessaggio("Conoscenza aggiornata con successo!", "success");

            } catch (error) {
                console.error(error);
                mostraMessaggio("Errore: " + error.message, "error");
                alert("Errore durante la connessione all'API. Verifica la tua chiave.");
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }

        function aggiornaInterfaccia(rawText) {
            const grid = document.getElementById('grid');
            const lines = rawText.split('\n').filter(line => line.trim() !== "");
            
            let html = "";
            categories.forEach(cat => {
                // Cerca la riga che contiene il nome della categoria
                let content = "Contenuto non generato correttamente.";
                const match = lines.find(l => l.toLowerCase().includes(cat.toLowerCase()));
                
                if (match) {
                    // Estrae il testo dopo i due punti
                    const parts = match.split(':');
                    if (parts.length > 1) {
                        content = parts.slice(1).join(':').trim();
                    }
                }

                html += `
                    <div class="card">
                        <h3>${cat}</h3>
                        <p>${content}</p>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
    </script>
</body>
</html>
